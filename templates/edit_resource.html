{% extends 'base.html' %}
    {% block content %}
    <div class="bg-white p-6 rounded-lg shadow-sm" x-data="{ 
        isHealthCheckEnabled: {{ 'true' if resource.is_health_check_enabled else 'false' }},
        sendEmail: {{ 'true' if resource.send_failure_email else 'false' }},
        sendWebhook: {{ 'true' if resource.send_failure_webhook else 'false' }}
    }">
        <h2 class="text-lg font-semibold mb-4">Edit Resource: {{ resource.name }}</h2>
        <form class="grid grid-cols-1 gap-4" method="post" action="/resources/edit/{{ resource.id }}" id="resource-form">
            <!-- Basic Info -->
            <div class="grid grid-cols-1 gap-3">
                <label class="text-sm font-medium">Name</label>
                <input name="name" class="p-2 border rounded" value="{{ resource.name }}" required />
                <label class="text-sm font-medium">Endpoint URL</label>
                <input name="endpoint" class="p-2 border rounded" value="{{ resource.endpoint }}" required />
            </div>

            <!-- Dynamic Headers -->
            <div class="border p-3 rounded">
                <label class="text-sm font-medium">Headers</label>
                <div id="headers-container" class="mt-2 space-y-2"></div>
                <div class="flex items-center gap-2 mt-3 pt-3 border-t">
                    <input type="text" id="new-header-key" placeholder="Key" class="p-2 border rounded w-1/3">
                    <input type="text" id="new-header-value" placeholder="Value" class="p-2 border rounded flex-grow">
                    <button type="button" id="add-header-btn" class="px-3 py-2 bg-gray-600 text-white rounded w-20">Add</button>
                </div>
            </div>

            <!-- Dynamic Required Params -->
            <div class="border p-3 rounded">
                <label class="text-sm font-medium">Required Payload Keys</label>
                <p class="text-xs text-gray-500 mt-1 mb-2">Define the keys that must be present in the JSON payload. Health check values are only required if health monitoring is enabled below.</p>
                <div id="params-container" class="mt-2 space-y-2"></div>
                <div class="flex items-center gap-2 mt-3 pt-3 border-t">
                    <input type="text" id="new-param-name" placeholder="Add payload key name..." class="p-2 border rounded flex-grow">
                    <button type="button" id="add-param-btn" class="px-3 py-2 bg-gray-600 text-white rounded w-20">Add</button>
                </div>
            </div>

            <!-- Health Check Configuration -->
            <div class="border p-3 rounded">
                <div class="flex items-center">
                    <input type="checkbox" id="hc-toggle" name="is_health_check_enabled" value="true" x-model="isHealthCheckEnabled" class="h-4 w-4 rounded">
                    <label for="hc-toggle" class="ml-2 block text-sm font-medium">Enable Health Check</label>
                </div>
                
                <div x-show="isHealthCheckEnabled" class="mt-3 pt-3 border-t space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">The gateway will periodically send a POST request to check health.</span>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium">Check every</label>
                            <input type="number" name="interval_min" value="{{ resource.interval_min }}" class="p-2 border rounded w-20">
                            <span class="text-sm">to</span>
                            <input type="number" name="interval_max" value="{{ resource.interval_max }}" class="p-2 border rounded w-20">
                            <select name="interval_unit" class="p-2 border rounded">
                                <option value="seconds" {% if resource.interval_unit == 'seconds' %}selected{% endif %}>Seconds</option>
                                <option value="minutes" {% if resource.interval_unit == 'minutes' %}selected{% endif %}>Minutes</option>
                                <option value="hours" {% if resource.interval_unit == 'hours' %}selected{% endif %}>Hours</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Email Notification Section -->
                    <div class="space-y-2 border-t pt-3">
                        <label class="flex items-center"><input type="checkbox" name="send_failure_email" value="true" x-model="sendEmail" class="h-4 w-4 rounded"><span class="ml-2 text-sm font-medium">Send Failure Notification Email</span></label>
                        <div x-show="sendEmail" class="pl-6 space-y-3">
                            <div><label class="text-sm font-medium">Recipient Emails</label><input type="text" name="notification_email" value="{{ resource.notification_email or '' }}" placeholder="alerts@example.com, admin@example.com" class="p-2 border rounded w-full mt-1"><p class="text-xs text-gray-500 mt-1">Comma-separated list of email addresses.</p></div>
                            <div><label class="text-sm font-medium">Subject</label><input type="text" name="notification_subject" value="{{ resource.notification_subject or default_subject }}" class="p-2 border rounded w-full mt-1 font-mono text-xs"></div>
                            <div><label class="text-sm font-medium">Body Template</label><p class="text-xs text-gray-500 mt-1">Placeholders: {resource_name}, {resource_endpoint}, {timestamp_utc}</p><textarea name="notification_template" class="p-2 border rounded w-full mt-1 font-mono text-xs" rows="6">{{ resource.notification_template or default_template }}</textarea></div>
                        </div>
                    </div>

                    <!-- Webhook Notification Section -->
                    <div class="space-y-2 border-t pt-3 mt-3">
                        <label class="flex items-center"><input type="checkbox" name="send_failure_webhook" value="true" x-model="sendWebhook" class="h-4 w-4 rounded"><span class="ml-2 text-sm font-medium">Trigger Failure Webhook</span></label>
                        <div x-show="sendWebhook" class="pl-6 space-y-3">
                            <div><label class="text-sm font-medium">Webhook URL</label><input type="url" name="failure_webhook_url" value="{{ resource.failure_webhook_url or '' }}" placeholder="https://api.example.com/webhook" class="p-2 border rounded w-full mt-1"></div>
                            <div><label class="text-sm font-medium">Headers (JSON)</label><textarea name="failure_webhook_headers" class="p-2 border rounded w-full mt-1 font-mono text-xs" rows="3">{% if resource.failure_webhook_headers %}{{ resource.failure_webhook_headers | tojson(indent=2) }}{% endif %}</textarea></div>
                            <div><label class="text-sm font-medium">Payload (JSON)</label><p class="text-xs text-gray-500 mt-1">You can use the same placeholders as the email template.</p><textarea name="failure_webhook_payload" class="p-2 border rounded w-full mt-1 font-mono text-xs" rows="4">{% if resource.failure_webhook_payload %}{{ resource.failure_webhook_payload | tojson(indent=2) }}{% endif %}</textarea></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end items-center space-x-3 border-t pt-4 mt-3">
                <a href="/resources" class="px-4 py-2 bg-gray-200 text-gray-800 rounded">Cancel</a>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save Changes</button>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        const form = document.getElementById('resource-form');
        const headersContainer = document.getElementById('headers-container');
        const paramsContainer = document.getElementById('params-container');

        function createHeaderRow(key, value) {
            if (!key) return;
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.innerHTML = `<input type="hidden" name="header_keys" value="${key}"><input type="hidden" name="header_values" value="${value || ''}"><input type="text" value="${key}" class="p-2 border rounded bg-gray-100 w-1/3" readonly><input type="text" value="${value || ''}" class="p-2 border rounded bg-gray-100 flex-grow" readonly><button type="button" class="px-3 py-2 bg-red-600 text-white rounded w-20 flex-shrink-0" onclick="this.parentElement.remove()">Remove</button>`;
            headersContainer.appendChild(row);
        }
        document.getElementById('add-header-btn').addEventListener('click', () => {
            const keyInput = document.getElementById('new-header-key');
            const valueInput = document.getElementById('new-header-value');
            createHeaderRow(keyInput.value.trim(), valueInput.value.trim());
            keyInput.value = ''; valueInput.value = '';
        });

        function createParamRow(paramName, testValue) {
            if (!paramName) return;
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.innerHTML = `
                <input type="hidden" name="required_params" value="${paramName}">
                <input type="text" value="${paramName}" class="p-2 border rounded bg-gray-100 flex-grow" readonly>
                <div x-show="isHealthCheckEnabled" class="flex-grow">
                    <input type="text" name="param_test_values" value="${testValue || ''}" placeholder="Health check value..." class="p-2 border rounded w-full">
                </div>
                <button type="button" class="px-3 py-2 bg-red-600 text-white rounded w-20 flex-shrink-0" onclick="this.parentElement.remove()">Remove</button>
            `;
            paramsContainer.appendChild(row);
        }
        document.getElementById('add-param-btn').addEventListener('click', () => {
            const nameInput = document.getElementById('new-param-name');
            createParamRow(nameInput.value.trim(), '');
            nameInput.value = '';
        });

        form.addEventListener('submit', function(event) {
            const hcEnabled = document.getElementById('hc-toggle').checked;
            if (!hcEnabled) return;

            let allValuesFilled = true;
            document.querySelectorAll('input[name=param_test_values]').forEach(input => {
                if (input.value.trim() === '') { allValuesFilled = false; }
            });
            if (!allValuesFilled) {
                event.preventDefault();
                alert('A "Health check value" is required for each payload key when Health Check is enabled.');
                return;
            }

            const sendEmailChecked = document.querySelector('input[name=send_failure_email]').checked;
            if (sendEmailChecked) {
                const emailInput = document.querySelector('input[name=notification_email]');
                if (!emailInput.value.trim()) {
                    event.preventDefault();
                    alert('When "Send Email" is enabled, Recipient Emails are required.');
                    return;
                }
            }
            
            const sendWebhookChecked = document.querySelector('input[name=send_failure_webhook]').checked;
            if (sendWebhookChecked) {
                const urlInput = document.querySelector('input[name=failure_webhook_url]');
                if (!urlInput.value.trim()) {
                    event.preventDefault();
                    alert('When "Trigger Webhook" is enabled, the Webhook URL is required.');
                    return;
                }
            }
        });

        // --- Pre-population logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const existingHeaders = {{ resource.headers | tojson | safe }};
            if (existingHeaders) { for (const [k, v] of Object.entries(existingHeaders)) { createHeaderRow(k, v); } }
            
            const existingParams = {{ resource.required_params | tojson | safe }};
            const existingTestValues = {{ resource.health_check_test_values | tojson | safe }};
            if (existingParams) {
                existingParams.forEach(param => {
                    createParamRow(param, existingTestValues ? existingTestValues[param] : '');
                });
            }
        });
    </script>
    {% endblock %}