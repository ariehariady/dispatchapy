{% extends 'base.html' %}
{% block content %}

<div class="bg-white p-6 rounded-lg shadow-sm" x-data='{
    devRulesEnabled: {{ ( ((client_dev_rules | default([]) | length) > 0) or (client.dev_rules_enabled if client else False) ) | tojson }}
}'>
    <h2 class="text-lg font-semibold mb-4">
        {% if is_client %}
        Client Settings: {{ client.name if client else '' }}
        {% elif client %}
        Edit Client: {{ client.name }}
        {% else %}
        Create New Client
        {% endif %}</h2>
    {% if error %}
        <script>try { alert({{ error | tojson | safe }}); } catch(e) { console.error('alert error', e); }</script>
    {% endif %}
    <form method="post" action="/clients/save" id="client-form">
        <div class="grid grid-cols-1 gap-4">
            {% if not is_client %}
            <div>
                <label class="text-sm font-medium">Name</label>
                <input name="name" class="p-2 border rounded w-full mt-1" value="{{ client.name if client else '' }}" required />
            </div>
            <div>
                <label class="text-sm font-medium">Description</label>
                <input name="description" class="p-2 border rounded w-full mt-1" value="{{ client.description if client else '' }}" />
            </div>
            {% endif %}
            <div>
                <label class="text-sm font-medium">Token</label>
                <div class="flex items-center gap-2">
                    <input name="token" id="client-token-input" class="p-2 border rounded w-full mt-1 font-mono" value="{{ client.token if client else generated_token }}" readonly />
                    <button type="button" id="copy-token" class="px-3 py-2 bg-gray-200 text-gray-800 rounded" title="Copy token">Copy</button>
                    {% if not is_client %}
                    <button type="button" id="regen-token" class="px-3 py-2 bg-gray-600 text-white rounded" {% if is_client %}disabled title="Administrators only"{% endif %}>Regenerate</button>
                    {% endif %}
                </div>
            </div>
            <div class="border p-3 rounded">
                <label class="text-sm font-medium">Associate Endpoints</label>
                <p class="text-xs text-gray-500 mt-1">Select endpoints this client may call. You can manage endpoint membership later from the Endpoint page.</p>
                <div id="endpoints-container" class="mt-2 space-y-2">
                    {# Server-render linked endpoints so edit view shows them immediately #}
                    {% if linked_endpoint_ids and all_endpoints %}
                        {% for e in all_endpoints %}
                            {% if e.id in linked_endpoint_ids %}
                                <div class="flex items-center gap-2" data-eid="{{ e.id }}">
                                    <input type="hidden" name="endpoint_ids" value="{{ e.id }}">
                                    <input type="text" class="p-2 border rounded bg-gray-100 flex-grow" value="/api/{{ e.path }}{% if e.description %} — {{ e.description }}{% endif %}" readonly>
                                    {% if not is_client %}  
                                    <button type="button" class="px-3 py-2 bg-red-600 text-white rounded w-20" onclick="this.parentElement.remove()" {% if is_client %}disabled title="Administrators only"{% endif %}>Remove</button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                {% if not is_client %}  
                <div class="flex items-center gap-2 mt-3 pt-3 border-t">
                    <select id="available-endpoint-select" class="p-2 border rounded flex-grow" {% if is_client %}disabled title="Administrators only"{% endif %}>
                        <option value="">-- Select endpoint to add --</option>
                        {% for e in all_endpoints %}
                            <option value="{{ e.id }}">/api/{{ e.path }}{% if e.description %} — {{ e.description }}{% endif %}</option>
                        {% endfor %}
                    </select>
                    <button type="button" id="add-endpoint-btn" class="px-3 py-2 bg-gray-600 text-white rounded w-20" {% if is_client %}disabled title="Administrators only"{% endif %}>Add</button>
                </div>
                {% endif %}
            </div>
            <div x-show="true" class="border p-3 rounded">
                <label class="text-sm font-medium mb-4">Task Overrides</label>
                    <div class="mb-4 mt-3">
                        <label class="inline-flex items-center space-x-2">
                            <input type="checkbox" name="dev_hold_tasks" value="1" class="form-checkbox h-4 w-4 text-indigo-600"
                                {% if client and client.dev_hold_tasks %}checked{% endif %}>
                            <span class="text-sm text-gray-700">Hold incoming tasks for manual inspection (place into <code>dev</code> state)</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">When enabled, incoming requests will be recorded but not processed by workers.</p>
                    </div>
                    <div class="mb-4">
                        <label class="inline-flex items-center space-x-2">
                            <input type="checkbox" name="dev_rules_enabled" value="1" x-model="devRulesEnabled" class="form-checkbox h-4 w-4 text-indigo-600"
                                {% if client and client.dev_rules_enabled %}checked{% endif %}>
                            <span class="text-sm text-gray-700">Apply Override rules</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">When enabled, the rules below will be applied to incoming requests.</p>
                    </div>
                    <div x-show="devRulesEnabled" style="display: none;">

                    <!-- Dev Section: Option to hold incoming tasks in dev state -->


                    <div id="dev-rules-container" class="space-y-2"></div>
                    <p id="dev-rules-error" class="text-sm text-red-600 hidden mt-2"></p>
                    <div class="mt-3 pt-3 border-t">
                        <button type="button" id="add-dev-rule-btn" class="px-3 py-2 bg-gray-600 text-white rounded text-sm">+ Add Dev Rule</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end items-center space-x-3 border-t pt-4 mt-6">
            <a href="/clients" class="px-4 py-2 bg-gray-200 text-gray-800 rounded">Cancel</a>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">{% if client %}Save Changes{% else %}Create Client{% endif %}</button>
        </div>
            {% if client %}
                <input type="hidden" name="id" value="{{ client.id }}" />
            {% endif %}
            <input type="hidden" name="client_dev_rules_json" id="client_dev_rules_json" />
    </form>
</div>
    <script>
        // bootstrap data for client rules UI
        window.__DPY_INIT_CLIENT_RULES = {
            available_rule_keys: {{ available_rule_keys | default([]) | tojson | safe }},
            client_dev_rules: {{ client_dev_rules | default([]) | tojson | safe }},
            all_endpoints: {{ all_endpoints | tojson | safe }},
            linked_endpoint_ids: {{ linked_endpoint_ids | default([]) | tojson | safe }}
        };
    </script>
    <script src="/static/alpine.min.js" defer></script>
    <script src="/static/client_rules.js" defer></script>
<script>
    const endpointsContainer = document.getElementById('endpoints-container');
    const availableEndpointSelect = document.getElementById('available-endpoint-select');
    const addEndpointBtn = document.getElementById('add-endpoint-btn');

    function createEndpointRow(eid, label) {
        if (!eid) return;
        if (!endpointsContainer) return;
        if (Array.from(endpointsContainer.querySelectorAll('[data-eid]')).some(el => el.dataset.eid === String(eid))) return;
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.dataset.eid = eid;
        row.innerHTML = `<input type="hidden" name="endpoint_ids" value="${eid}"><input type="text" class="p-2 border rounded bg-gray-100 flex-grow" value="${label}" readonly><button type="button" class="px-3 py-2 bg-red-600 text-white rounded w-20" onclick="this.parentElement.remove()">Remove</button>`;
        endpointsContainer.appendChild(row);
    }

    if (addEndpointBtn && availableEndpointSelect) {
        addEndpointBtn.addEventListener('click', () => {
            const val = availableEndpointSelect.value;
            if (!val) return;
            const label = availableEndpointSelect.options[availableEndpointSelect.selectedIndex].text;
            createEndpointRow(val, label);
            availableEndpointSelect.value = '';
        });
    }

    // If opened with ?endpoint_id=..., pre-populate that endpoint in the associated endpoints list
    (function(){
        try {
            const params = new URLSearchParams(window.location.search);
            const pre = params.get('endpoint_id');
            if (pre) {
                // try to find the option label
                try {
                    if (availableEndpointSelect) {
                        const opt = Array.from(availableEndpointSelect.options).find(o => o.value === String(pre));
                        const label = opt ? opt.text : ('/api/' + pre);
                        createEndpointRow(pre, label);
                        // remove the option from the select if we found it
                        try { if (opt) opt.remove(); } catch(e) {}
                    } else {
                        // no select present, still attempt to create a row with a simple label
                        createEndpointRow(pre, '/api/' + pre);
                    }
                } catch(e) {}
                // add a hidden return_to field so the server can redirect back to the endpoint's clients page after save
                try {
                    const form = document.getElementById('client-form');
                    const ret = document.createElement('input');
                    ret.type = 'hidden';
                    ret.name = 'return_to';
                    ret.value = '/endpoints/' + String(pre) + '/clients?is_new=1';
                    form.appendChild(ret);
                } catch(e) {}
            }
        } catch(e) { /* ignore if not available */ }
    })();

    // Pre-populate linked endpoints when editing an existing client (bootstrapped from server)
    (function(){
        try {
            const linked = (window.__DPY_INIT_CLIENT_RULES && window.__DPY_INIT_CLIENT_RULES.linked_endpoint_ids) || [];
            if (Array.isArray(linked) && linked.length) {
                linked.forEach(id => {
                    try {
                        if (availableEndpointSelect) {
                            const opt = Array.from(availableEndpointSelect.options).find(o => o.value === String(id));
                            const label = opt ? opt.text : ('/api/' + id);
                            createEndpointRow(id, label);
                            try { if (opt) opt.remove(); } catch(e) {}
                        } else {
                            createEndpointRow(id, '/api/' + id);
                        }
                    } catch(e) { /* ignore per-row errors */ }
                });
            }
        } catch(e) { /* ignore if not available */ }
    })();

    try {
        const regenBtn = document.getElementById('regen-token');
        if (regenBtn) regenBtn.addEventListener('click', () => {
            // lightweight token regeneration UI: request a new token from server endpoint if available
            // For now just generate a client-side random token placeholder (server will override on save)
            const tokenInput = document.querySelector('input[name=token]');
            try { tokenInput.value = 'dpy_' + Math.random().toString(36).slice(2,12) + Math.random().toString(36).slice(2,12); } catch(e){}
        });
    } catch(e) { /* noop */ }

    // copy token button handler (safe-guarded for when the button exists)
    try {
        const copyBtn = document.getElementById('copy-token');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => {
                const tokenInput = document.querySelector('input[name=token]');
                if (!tokenInput) return;
                const val = tokenInput.value || '';
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(val).then(() => {
                        const orig = copyBtn.innerHTML;
                        copyBtn.innerHTML = 'Copied';
                        try { alert('Token has copied to clipboard'); } catch(e) {}
                        setTimeout(() => { copyBtn.innerHTML = orig; }, 2000);
                    }).catch(() => {
                        // fallback to execCommand
                        try { tokenInput.select(); document.execCommand('copy'); copyBtn.innerHTML = 'Copied'; try { alert('Token has copied to clipboard'); } catch(e) {} setTimeout(()=>copyBtn.innerHTML = 'Copy',2000);} catch(e){ alert('Copy failed'); }
                    });
                } else {
                    // older browsers
                    try { tokenInput.select(); document.execCommand('copy'); copyBtn.innerHTML = 'Copied'; try { alert('Token has copied to clipboard'); } catch(e) {} setTimeout(()=>copyBtn.innerHTML = 'Copy',2000);} catch(e){ alert('Copy not supported in this browser'); }
                }
            });
        }
    } catch(e) { /* noop if DOM APIs not available */ }

    // client rules UI moved to /statics/client_rules.js
</script>

{% endblock %}
